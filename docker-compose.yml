version: "3.8"
services:
  router:
    env_file:
      - .env
    image: traefik:v3.0
    container_name: "router"
    ports:
      - "80:80"
      - "443:443" # Add port 443 for HTTPS
    volumes:
      - "./traefik.yml:/etc/traefik/traefik.yml"
      - "/letsencrypt:/letsencrypt"
      - "/var/log/eb-docker/containers/router:/log"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - traefik-net
    restart: always

  api:
    build:
      context: ./directus
      dockerfile: Dockerfile
    image: directus/directus:10.11.0
    env_file:
      - .env
    container_name: api
    restart: on-failure
    ports:
      - "8055:8055"
    environment:
      HOST: 0.0.0.0
      PORT: 8055
      PUBLIC_URL: "api.i-code.xyz"
      DB_SSL: "true"
      RATE_LIMITER_ENABLED: "false"
      RATE_LIMITER_STORE: "memory"
      RATE_LIMITER_POINTS: 25
      RATE_LIMITER_DURATION: 1
      CACHE_ENABLED: "false"
      CACHE_AUTO_PURGE: "true"
      CACHE_AUTO_PURGE_IGNORE_LIST: "directus_activity,directus_presets"
      CACHE_STORE: "memory"
      ASSETS_CACHE_TTL: "1d"
      STORAGE_LOCATIONS: "Cloudinary"
      STORAGE_CLOUDINARY_DRIVER: "cloudinary"
      ACCESS_TOKEN_TTL: "15m"
      SESSION_COOKIE_NAME: "directus_session_token"
      SESSION_COOKIE_SAME_SITE: "lax"
      SESSION_COOKIE_SECURE: "false"
      SESSION_COOKIE_TTL: "1d"
      REFRESH_TOKEN_TTL: "7d"
      REFRESH_TOKEN_COOKIE_SECURE: "false"
      REFRESH_TOKEN_COOKIE_SAME_SITE: "lax"
      REFRESH_TOKEN_COOKIE_NAME: "directus_refresh_token"
      CORS_ENABLED: "true"
      KEY: "${KEY_DIRECTUS}"
      SECRET: "${SECRET_DIRECTUS}"
      CORS_ORIGIN: "*"
      CORS_METHODS: "GET,POST,PATCH,DELETE"
      CORS_ALLOWED_HEADERS: "Content-Type,Authorization"
      CORS_EXPOSED_HEADERS: "Content-Range"
      CORS_CREDENTIALS: "true"
      CORS_MAX_AGE: 18000
      EXTENSIONS_PATH: "./extensions"
      EXTENSIONS_AUTO_RELOAD: "true"
      EMAIL_ALLOW_GUEST_SEND: "false"
      EMAIL_VERIFY_SETUP: "true"
      TELEMETRY: "false"
      GRAPHQL_INTROSPECTION: "true"
      CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_SRC: "i-code.xyz"
    depends_on:
      - router
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.i-code.xyz`)"
      - "traefik.http.routers.api.entrypoints=web,websecure"
      - "traefik.http.services.api.loadbalancer.server.port=8055"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.api-redirect-www.redirectregex.regex=^http://www\\.api\\.i-code\\.xyz/(.*)"
      - "traefik.http.middlewares.api-redirect-www.redirectregex.replacement=https://api.i-code.xyz/$${1}"
      - "traefik.http.middlewares.api-redirect-www.redirectregex.permanent=true"

networks:
  traefik-net:
    name: traefik-net
